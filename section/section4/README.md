# 4. 카프카 상세 개념 설명
목차

- 토픽과 파티션
- 카프카 프로듀서
- 카프카 컨슈머
- 스프링 카프카
- 정리

## 토픽과 파티션

### 적정 파티션 개수

토픽의 파티션 개수는 카프카의 성능과 관련이 있으므로 적절한 파티션 개수를 설정하고 운영하는 것이 중요하다.

토픽 생성시 파티션의 개수를 정하는 데에 고려해야 할 점은 3가지 이다.

- 데이터 처리량
- 메시지 키 사용 여부
- 브로커, 컨슈머 영향도
    - 카프카는 파일시스템을 사용하므로 파티션의 수 만큼 파일을 접근한다고 보면 된다.</br>
      이는 운영체제 특성상 프로세스당 열 수 있는 파일 최대 개수가 있으므로 브로커가 접근하는 파일 개수를 안정적으로 유지하기 위해서는 카프카 브로커를 늘려야 한다.</br>

데이터 처리 속도를 올리는 방법은 2가지 이다.

1. 컨슈머의 처리량을 늘리는 방법
    - 컨슈머의 처리량을 늘리기 위해서는 컨슈머가 실행되는 서버를 스케일 업하거나 GC 튜닝 등 하는 것이다.</br>
      하지만 컨슈머 특성상 다른 시스템(S3, 하둡, 오라클 등)과 연동되기 때문에 일정 수준 이상 처리량을 올리기가 힘들다.</br>
2. 컨슈머를 추가하여 병렬처리량을 늘리는 방법 (해당 방법이 확실한 방법)
    - 파티션 개수를 늘려 파티션 개수 만큼 컨슈머를 추가</br>
      Ex. 프로듀서가 보내는 데이터가 초당 1,000 레코드 이고 컨슈머가 처리할 수 있는 데이터가 초당 100 레코드라면 최소한으로 필요한 파티션의 개수는 10개이다.</br></br>
      파티션 개수만 무조건 늘리는 것은 좋지 않을 수 있다.</br>
      이유는 파티션 개수를 늘림에 따라 컨슈머와 브로커의 부담이 커질 수 있기 때문이다. 이 또한 고려하여야 한다.

### 토픽 정리 정책(cleanup.policy)

**토픽 삭제 정책(delete policy)**

토픽의 데이터를 삭제할 때는 세그먼트 단위로 삭제를 진행한다.</br>
세그먼트는 토픽의 데이터를 저장하는 명시적인 파일 시스템 단위이다. 그리고 파티션마다 별개로 생성되며 세그먼트의 파일 이름은 오프셋 중 가장 작은 값이 된다.</br>
세그먼트는 여러 조각으로 나뉘는데 segment.bytes 옵션으로 1개의 세그먼트 크기를 설정할 수 있다.</br>
segment.bytes 크기보다 커질 경우에는 기존에 적재하던 세그먼트 파일을 닫고 새로운 새그먼트를 열어서 데이터를 저장한다.</br>

삭제 정책이 실행되는 시점은 시간 또는 용량이 기준이 된다.</br>
retention.ms 는 토픽의 데이터를 유지하는 기간을 밀리초로 설정할 수 있다.</br>
카프카는 일정 주기마다 세그먼트 파일의 마지막 수정 시간과 retention.ms 를 비교하는데, 세그먼트 파일의 마지막 수정 시간이 retention.ms 를 넘어가면 세그먼트는 삭제된다.</br>
그리고 retention.bytes 는 토픽의 최대 데이터 크기를 제어한다.</br>
retention.bytes 를 넘어간 세그먼트 파일들은 삭제된다.</br>
삭제된 데이터는 복구할 수 없다.</br>

**토픽 압축 정책(compact policy)**

토픽 압축 정책이란 메시지 키별로 해당 메시지 키의 레코드 중 오래된 데이터를 삭제하는 정책이다.</br>
압축 정책은 액티브 세그먼트를 제외한 나머지 세그먼트들에 한해서만 데이터를 처리한다.</br>
데이터의 압축 시작 시점은 min.cleanable.clity.ratio 옵션값을 따른다.</br>
min.cleanable.clity.ratio 옵션값은 액티브 세그먼트를 제외한 세그먼트에 남아 있는 데이터의 tail 영역의 레코드 개수와 head 영역의 레코드 개수의 비율을 뜻한다.</br>

<img src="/img/4.1.2-3.png" width="1000px;">

tail 영역의 레코드들은 ‘clean log’ 라 부르고 압축이 완료됐기 때문에 tail 영역에는 중복된 메시지 키가 없다.

head 영역의 레코드들은 ‘dirty log’ 라고 부르고 압축이 되기 전 레코드들이 있으므로 중복된 메시지 키를 가진 레코드들이 있다.

토픽의 압축은 min.cleanable.clity.ratio 값에 따라 수행되는데, 옵션값을 0.5 로 설정할 경우 dirty log 비율이 0.5 가 넘어가면 압축이 수행된다.

옵션값이 낮을 수록 압축이 더 자주 발생하게되는데 자주 발생하는 만큼 브로커에 부담을 줄 수 었으므로 적절한 값을 설정하는 것이 중요하다.
